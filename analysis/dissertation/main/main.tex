% main.tex - PhD Dissertation Template
% This template provides a structured outline for a PhD dissertation.
% It includes commonly used packages, chapter structure, and placeholders.
% Use this file as a starting point and fill in your content in each section.

\documentclass[12pt]{report}  % Use the report class as a basis for the dissertation

% ---------------------------------------------------
% Packages and Configuration
% ---------------------------------------------------
\usepackage[utf8]{inputenc}    % Ensure UTF-8 encoding
\usepackage[T1]{fontenc}       % Use T1 font encoding for accented characters
\usepackage{graphicx}          % For including graphics (figures)
\usepackage{amsmath}           % AMS math package for advanced mathematics
\usepackage{mathtools}         % Math extensions (psmallmatrix, etc.)
\usepackage{amsthm}            % Theorem environments
\usepackage{amssymb}         % Additional math symbols (e.g., mathbb)
\usepackage{amsfonts}        % Math fonts used in chapter content
\usepackage{algorithm}        % Algorithm floats
\usepackage[noend]{algpseudocode} % Algorithmicx pseudocode (no end/endif lines)
% Slightly tighter algorithm floats
\floatname{algorithm}{Algorithm}
\renewcommand{\thealgorithm}{\arabic{chapter}.\arabic{algorithm}}
% Convenience macros for Require/Ensure labels
\algrenewcommand\algorithmicrequire{\textbf{Require:}}
\algrenewcommand\algorithmicensure{\textbf{Ensure:}}
\usepackage{booktabs}          % Professional-quality tables
\usepackage{tabularx}          % Flexible tables with automatic column widths
\usepackage{adjustbox}         % Constrain table/figure width to \linewidth
\usepackage{ragged2e}          % Better ragged-right for X columns
\usepackage{array}             % Column helpers (newcolumntype)
\usepackage{threeparttable}    % Pretty table caption + notes block
\usepackage{changepage}        % Temporary margin adjustments (adjustwidth)
\usepackage{caption}           % Custom captions for figures/tables
\usepackage{subcaption}        % Sub-figures and sub-tables
\usepackage{enumitem}          % Control layout of itemize/enumerate
\usepackage{natbib}            % Natbib for citations (author-year support)
\usepackage{xcolor}            % Colors (required by todonotes)
% Global accent palette (colorblind-safe blue)
\definecolor{accentBlue}{RGB}{31,119,180}
\usepackage[disable]{todonotes} % Disable todo notes for clean builds
\usepackage{fvextra}           % Enhanced verbatim; enables wrapping and customization
\usepackage{alphalph}          % Multi-letter counters (e.g., AA, AB) for many appendices
\usepackage{setspace}          % Line spacing control (single/onehalf/double)
\usepackage[protrusion=true,expansion=true]{microtype} % Better typography
% Computer Modern (LaTeX default) - no font package needed
% This provides the classic LaTeX appearance with superior math typesetting
% (mathpazo removed to use default Computer Modern fonts)
\usepackage{tikz}                % TikZ for diagrams/flowcharts
\usetikzlibrary{arrows.meta,positioning,calc}
\usepackage{pgfplots}            % Vector plots for inline charts (e.g., feature importance)
\pgfplotsset{compat=1.18}
% Default, slightly smaller pgfplots text for figures
\pgfplotsset{every axis/.append style={
  label style={font=\footnotesize},
  tick label style={font=\scriptsize},
  title style={font=\footnotesize}
}}
\usepackage{xparse}            % For robust macro definitions with optional args
\usepackage{needspace}         % Prevent headings stranded at page bottoms
\usepackage{etoolbox}          % Patch commands (preto for section guards)
\usepackage{placeins}          % FloatBarrier command for controlling float placement
% (pdfpages removed)
\usepackage{listings}          % For code listings (SQL, Python, etc.)
\lstset{
  basicstyle=\ttfamily\footnotesize,
  breaklines=true,
  columns=flexible,
  keepspaces=true
}
\usepackage[
    inner=1.25in,
    outer=1.25in,
    top=1.0in,
    bottom=1.05in
]{geometry}                 % Page geometry and margins (simplified)
% Avoid todonotes margin width warnings even when disabled
\setlength{\marginparwidth}{2cm}
% Make verbatim blocks wrap long lines and set a compact font size
\RecustomVerbatimEnvironment{verbatim}{Verbatim}{breaklines,breakanywhere,fontsize=\footnotesize}
% Provide extra stretch to reduce Underfull \hbox warnings globally
\emergencystretch=2em
% Avoid widow/club lines and lonely display lines across pages
\clubpenalty=10000
\widowpenalty=10000
\displaywidowpenalty=10000
% Ensure headings don't appear at page bottoms with no body text
% Reserve space before starting new headings (adjust baselines as needed)
\preto\section{\Needspace{6\baselineskip}}
\preto\subsection{\Needspace{5\baselineskip}}
\preto\subsubsection{\Needspace{4\baselineskip}}
% Helpful hyphenation hints for long words used throughout
\hyphenation{miss-speci-fication micro-struc-ture multi-leg mar-gin-par re-weight-ing
  de-pen-dence-cal-i-bra-tion sys-tem-of-sys-tems off-line-RL
  mar-ket-mi-cro-struc-ture ma-te-ri-al-ized}

% ---------------------------------------------------
% Table helpers and caption styling
% ---------------------------------------------------
% Ragged-right, auto-wrapping X-style columns.
% Use \begin{tabularx}{\linewidth}{@{} l Y Y @{} } ... \end{tabularx}
\newcolumntype{Y}{>{\RaggedRight\arraybackslash}X}
\newcolumntype{L}{>{\RaggedRight\arraybackslash}X}
% Slightly smaller table captions and content by default
\captionsetup[table]{font=small}
\captionsetup[figure]{font=small}

% ---------------------------------------------------
% Theorem style with margin headings (slick variant)
% ---------------------------------------------------
% (removed thmtools + margin-based theorem style)
% Number equations by section, not chapter
\numberwithin{equation}{section}
% Use standard theorem style
\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
% Non-italic environments keep normal headings
\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{assumption}[theorem]{Assumption}
\newtheorem{example}[theorem]{Example}
\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}

% Allow line breaks in URLs
\PassOptionsToPackage{hyphens}{url}
\usepackage[unicode=true,colorlinks=true, linkcolor=blue, citecolor=blue, urlcolor=blue]{hyperref}
% Ensure unique hyperlink anchors even if counters repeat
\hypersetup{hypertexnames=false}
% ^ Hyperref for hyperlinks: should be loaded last to avoid conflicts.
% (It makes references, citations, and URLs clickable in the PDF.)

\usepackage[nameinlink]{cleveref}
\crefname{algorithm}{Algorithm}{Algorithms}
\Crefname{algorithm}{Algorithm}{Algorithms}

% Ensure there is room for headings + a few lines of body text
\preto\section{\Needspace{4\baselineskip}}
\preto\subsection{\Needspace{3\baselineskip}}
\preto\subsubsection{\Needspace{3\baselineskip}}

% (removed marginpar warning filter)

% Bibliography style (natbib with plainnat for author-year citations)
\renewcommand{\bibname}{References}   % Rename the bibliography section to "References"

% ---------------------------------------------------
% Custom Commands (if any)
% ---------------------------------------------------
% Front/back matter helpers for report class
\providecommand{\frontmatter}{\pagenumbering{roman}}
\providecommand{\mainmatter}{\cleardoublepage\pagenumbering{arabic}}
\providecommand{\backmatter}{\cleardoublepage}
% Footnote helpers used across chapters
% \mn{text} creates a footnote; optional offset is ignored for compatibility
\providecommand{\mn}[2][0pt]{\footnote{#2}}
% Compatibility shifters -> regular footnotes
\newcommand{\mnup}[2]{\footnote{#2}}
\newcommand{\mndown}[2]{\footnote{#2}}
% Canonical subsection helpers used for literature summaries
\newcommand{\sdesc}[1]{\par\noindent\textbf{Summary.} #1\par}
\newcommand{\mdesc}[1]{\par\noindent\textbf{Math.} #1\par}
\newcommand{\appdesc}[1]{\par\noindent\textbf{NFL application.} #1\par}
\newcommand{\bridge}[1]{\par\noindent\textit{Why this leads to the next:} #1\par}
% Chapter summary helper: a consistent end-of-chapter recap + forward pointer
\newcommand{\chaptersummary}[2]{%
  \section*{Chapter Summary}% unnumbered but visually distinct
  \addcontentsline{toc}{section}{Chapter Summary}% add to TOC
  \noindent #1\par\medskip
  \noindent\textit{Next:} #2\par
}
% You can define custom LaTeX commands here if needed, for example:
% \newcommand{\R}{\mathbb{R}}  % shortcut for real numbers symbol
% \newcommand{\todofig}[1]{\todo[inline]{Include figure: #1}}  % inline todo for figures, etc.

% Math convenience macros used across chapters
\newcommand{\E}{\mathbb{E}}
\newcommand{\Prob}{\mathbb{P}}
\newcommand{\Var}{\mathrm{Var}}
\newcommand{\Cov}{\mathrm{Cov}}
\newcommand{\vect}[1]{\mathbf{#1}}
\newcommand{\dd}{\mathrm{d}}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

% Hyphenation & layout tuning
\Urlmuskip=0mu plus 1mu

% Footnote configuration

% ---------------------------------------------------
% Document Content
% ---------------------------------------------------
\begin{document}
\singlespacing  % Single-spaced body; typography handled by microtype
\emergencystretch=3em % Reduce overfull hbox warnings gracefully

\frontmatter

% Title Page (you may need to adjust this to your institution's requirements)
\title{Edge Under Uncertainty: Designing Robust AI Systems for NFL Betting Markets%
\\[0.5em]%
\large A System-of-Systems Integrating Calibrated Prediction, Offline Reinforcement Learning, and Portfolio Risk Management}            % Replace with your dissertation title
\author{Richard Oldham}                    % Replace with your name
\date{\today}                           % You can set a fixed date if preferred
% Avoid duplicate hyperref anchors on roman pages
\hypersetup{pageanchor=false}
\maketitle

% Front Matter
% (Optional dedication, abstract, acknowledgments can be included as unnumbered chapters)
\chapter*{Abstract}
This dissertation presents a system-of-systems for prediction, decision‑making, and governance in National Football League (NFL) betting markets. The work integrates a reproducible data layer, calibrated probabilistic models, conservative offline reinforcement learning (RL), and risk controls that make policies deployable in practice.

On the data side, idempotent ingestion pipelines build governed TimescaleDB marts from play‑by‑play, odds history, weather, and schedule context. Modeling begins with calibrated baselines (logistic/probit and state‑space team ratings) and a score‑distribution layer that prices spreads and totals via Skellam and bivariate Poisson models. We introduce an integer‑margin reweighting procedure that matches empirical key‑number masses (3, 6, 7, 10) while preserving location/scale, and we model spread–total dependence with Gaussian/$t$ copulas to price correlated legs.

Edges are converted into actions with offline RL (IQL/CQL/TD3+BC/AWAC) under safety constraints. Policies are promoted only when off‑policy evaluation (self‑normalized importance sampling, doubly robust, and high‑confidence bounds) passes stability checks. Stake sizing combines fractional Kelly with friction/cap projections and portfolio‑level CVaR constraints. A Monte Carlo simulator, calibrated to historical margins and dependence and instrumented with frictions and liquidity, provides acceptance tests and stress scenarios.

Across rolling out‑of‑sample seasons, the stack delivers improved probability calibration, consistent closing‑line value (CLV) capture, and superior risk‑adjusted returns relative to classical baselines, while materially reducing drawdowns under pessimistic friction regimes. Contributions include: (i) a reproducible NFL data mart and feature pipeline; (ii) dependence‑aware, key‑number‑calibrated pricing of discrete margins; (iii) a conservative offline‑RL+OPE gate for promotion; and (iv) a governance playbook linking uncertainty to portfolio risk.\par
\addcontentsline{toc}{chapter}{Abstract}

% Code and Data Availability
\chapter*{Code and Data Availability}
\addcontentsline{toc}{chapter}{Code and Data Availability}

All code, documentation, and analysis scripts supporting this dissertation are publicly available at:

\begin{center}
\url{https://github.com/raold/nfl-analytics}
\end{center}

The repository includes:
\begin{itemize}
  \item Complete data ingestion pipelines for NFL play-by-play data (1999--2024)
  \item TimescaleDB schema and materialized views
  \item Feature engineering and model implementation code
  \item Reinforcement learning agents and training scripts
  \item Monte Carlo simulation framework
  \item Statistical testing and validation notebooks
  \item LaTeX source files for this dissertation
\end{itemize}

\paragraph{Reproducibility.}
The codebase is designed for full reproducibility. All random seeds are fixed, dependencies are pinned via \texttt{requirements.txt} (Python) and \texttt{renv.lock} (R), and the README provides step-by-step instructions for replicating all results. The experiment registry tracks all model runs with hashed parameters and metrics.

\paragraph{Data Sources.}
Primary data sources include:
\begin{itemize}
  \item \textbf{nflfastR}: Play-by-play data via the R package ecosystem
  \item \textbf{The Odds API}: Historical betting lines (API key required)
  \item \textbf{Meteostat}: Weather data for game conditions
  \item \textbf{NFL official data}: Schedules, rosters, and injury reports
\end{itemize}

\paragraph{License.}
The code is released under the MIT License for academic and research use. Commercial use of betting-related components should comply with local regulations.

% Table of Contents, List of Figures, and List of Tables
\cleardoublepage
\phantomsection
% Use sloppy typesetting locally to reduce Overfull \hbox warnings in ToC/LoF/LoT
\begingroup\sloppy\RaggedRight\emergencystretch=6em
\tableofcontents
\endgroup

\cleardoublepage
\phantomsection
\addcontentsline{toc}{chapter}{List of Figures}
\begingroup\sloppy\RaggedRight\emergencystretch=6em
\listoffigures
\endgroup

\cleardoublepage
\phantomsection
\addcontentsline{toc}{chapter}{List of Tables}
\begingroup\sloppy\RaggedRight\emergencystretch=6em
\listoftables
\endgroup

% Insert master TODOs after lists (front matter), integrated styling
\cleardoublepage
\phantomsection
\IfFileExists{../appendix/notation_glossary.tex}{\input{../appendix/notation_glossary.tex}}{}
\IfFileExists{../appendix/acronyms.tex}{\input{../appendix/acronyms.tex}}{}
\IfFileExists{../appendix/master_todos.tex}{\input{../appendix/master_todos.tex}}{}
\IfFileExists{../appendix/systems_blueprint.tex}{\input{../appendix/systems_blueprint.tex}}{}
\IfFileExists{../appendix/productionization_guide.tex}{\input{../appendix/productionization_guide.tex}}{}
% \listoftodos

% ---------------------------------------------------
% Main Matter
% ---------------------------------------------------
% Re-enable page anchors for main matter
\hypersetup{pageanchor=true}
\mainmatter

% ---------------------------------------------------
% Chapters
% ---------------------------------------------------

\input{../chapter_1_intro/chapter_1_intro.tex}
\input{../chapter_2_lit_review/chapter_2_lit_review.tex}
\input{../chapter_3_data_foundation/chapter_3_data_foundation.tex}
\input{../chapter_4_baseline_modeling/chapter_4_baseline_modeling.tex}
\input{../chapter_5_rl_design/chapter_5_rl_design.tex}
\input{../chapter_6_uncertainty_risk_betting/chapter_6_uncertainty_risk_betting.tex}
\input{../chapter_7_simulation/chapter_7_simulation.tex}
\input{../chapter_8_results_discussion/chapter_8_results_discussion.tex}
\input{../chapter_9_production_deployment/chapter_9_production_deployment.tex}
\input{../chapter_10_conclusion/chapter_10_conclusion.tex}
\input{../chapter_11_market_optimization/chapter_11_market_optimization.tex}
\input{../chapter_12_profit_optimization/chapter_12_profit_optimization.tex}

% ---------------------------------------------------
% Appendix (consolidated)
% ---------------------------------------------------
\appendix
% Keep multi-letter appendix counters (AA, AB, ...)
\makeatletter
\renewcommand\thechapter{\AlphAlph{\value{chapter}}}
\makeatother

% Include consolidated appendix (8 chapters, 1283 lines)
\input{../appendix/appendix_consolidated.tex}

% ---------------------------------------------------
% Back Matter and References
% ---------------------------------------------------
\backmatter
\cleardoublepage
\phantomsection
\addcontentsline{toc}{chapter}{References}  % Include References in TOC
\bibliographystyle{plainnat}
\bibliography{../references}  % references.bib is the bibliography database file

\end{document}
