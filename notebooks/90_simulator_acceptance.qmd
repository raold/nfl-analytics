---
title: "90 â€“ Simulator Acceptance Tests: Outcomes"
format:
  html:
    code-fold: true
execute:
  echo: true
  warning: false
  message: false
params:
  seasons: [2020, 2021, 2022, 2023, 2024]
  output_dir: "analysis/dissertation/figures/out"
---

## Goal
Summarize simulator acceptance test outcomes: pass/fail rates, typical deviations when failing, and relationship with live performance. Outputs feed Chapter 7.

```{r}
library(dplyr)
library(ggplot2)
library(knitr)

# Ensure output_dir is absolute path
output_dir <- params$output_dir
if (!grepl("^/", output_dir)) {
  output_dir <- file.path(dirname(dirname(getwd())), output_dir)
}
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)

# This notebook expects an acceptance log (per week/season/test) and live metrics per week.
# If absent, write placeholders; otherwise compute real figures.

acc_path <- "analysis/results/sim_acceptance.csv"
live_path <- "analysis/results/live_metrics.csv"

if (file.exists(acc_path)) {
  acc <- readr::read_csv(acc_path, show_col_types = FALSE)
  # Expect: season, week, test, pass (0/1), deviation
  rates <- acc |>
    group_by(season, test) |>
    summarise(pass_rate = mean(pass, na.rm = TRUE), n = n(), .groups = "drop")
  p <- ggplot(rates, aes(x = factor(season), y = pass_rate, fill = test)) +
    geom_col(position = position_dodge()) +
    scale_y_continuous(labels = scales::percent) +
    labs(x = "Season", y = "Pass rate", fill = "Test", title = "Simulator acceptance pass/fail rates") +
    theme_minimal(base_size = 12)
  ggsave(file.path(params$output_dir, "sim_acceptance_rates.png"), p, width = 9, height = 4.5, dpi = 200)

  dev_tbl <- acc |>
    filter(pass == 0) |>
    group_by(test) |>
    summarise(Mean_dev = mean(deviation, na.rm = TRUE),
              CI95 = paste0(round(Mean_dev - 1.96*sd(deviation,na.rm=TRUE)/sqrt(n()), 3),
                             ", ",
                             round(Mean_dev + 1.96*sd(deviation,na.rm=TRUE)/sqrt(n()), 3)),
              N_fails = n(), .groups = "drop")
  writeLines(knitr::kable(dev_tbl, format = "latex", booktabs = TRUE,
                          caption = "Typical deviations when acceptance tests fail."),
             con = file.path(params$output_dir, "sim_fail_deviation_table.tex"))

  if (file.exists(live_path)) {
    live <- readr::read_csv(live_path, show_col_types = FALSE) # Expect: season, week, clv_bps, roi
    acc_week <- acc |>
      group_by(season, week) |>
      summarise(pass_all = as.integer(all(pass == 1)), .groups = "drop") |>
      left_join(live, by = c("season","week"))
    p2 <- ggplot(acc_week, aes(x = pass_all, y = clv_bps)) +
      geom_boxplot() +
      scale_x_continuous(breaks = c(0,1), labels = c("Fail","Pass")) +
      labs(x = "Acceptance outcome (all tests)", y = "CLV (bps)", title = "Acceptance vs live CLV") +
      theme_minimal(base_size = 12)
    ggsave(file.path(params$output_dir, "sim_acceptance_vs_live_perf.png"), p2, width = 9, height = 4.5, dpi = 200)
  } else {
    png(file.path(params$output_dir, "sim_acceptance_vs_live_perf.png"), width = 900, height = 450)
    plot.new(); text(0.5, 0.5, "Placeholder: Acceptance vs live performance")
    dev.off()
  }
} else {
  # Placeholder acceptance rates figure
  png(file.path(params$output_dir, "sim_acceptance_rates.png"), width = 900, height = 450)
  plot.new(); text(0.5, 0.5, "Placeholder: Acceptance pass/fail rates by season")
  dev.off()

  # Placeholder deviations table
  dev_tbl <- data.frame(Test = c("Margin RMSE", "Key mass abs. error", "Dependence rho error"),
                        Mean_dev = NA_real_, CI95 = NA_character_, N_fails = NA_integer_)
  writeLines(knitr::kable(dev_tbl, format = "latex", booktabs = TRUE,
                          caption = "Typical deviations when acceptance tests fail (placeholder)."),
             con = file.path(params$output_dir, "sim_fail_deviation_table.tex"))

  # Placeholder acceptance vs live performance
  png(file.path(params$output_dir, "sim_acceptance_vs_live_perf.png"), width = 900, height = 450)
  plot.new(); text(0.5, 0.5, "Placeholder: Acceptance vs live performance")
  dev.off()
}
```
